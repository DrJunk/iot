<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>IRPi - The Universal IoT IR Remote</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/half-slider.css" rel="stylesheet">
	<link href="css/AboutUs.css" rel="stylesheet">

  </head>

  <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#">IRPi</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="#">Home
                <!--<span class="sr-only">(current)</span>-->
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#about">IRPi</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#demo">Demo</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#features">Features</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#ir">IR</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#circuit">Circuit</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#cloud">Cloud</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#api">API</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#code">Code</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#us">About</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <header>
      <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
        <ol class="carousel-indicators">
          <!--<li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
          <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
          <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>-->
        </ol>
        <div class="carousel-inner" role="listbox">
          <!-- Slide One - Set the background image for this slide in the line below -->
          <div class="carousel-item active" style="background-image: url(https://ak5.picdn.net/shutterstock/videos/22213399/thumb/1.jpg)">
            <div class="carousel-caption d-none d-md-block">
              <h3>IRPi</h3>
              <p>The Universal IoT IR Remote.</p>
            </div>
          </div>

          <!-- Slide Two - Set the background image for this slide in the line below -->
          <!--<div class="carousel-item" style="background-image: url('http://placehold.it/1900x1080')">
            <div class="carousel-caption d-none d-md-block">
              <h3>Second Slide</h3>
              <p>This is a description for the second slide.</p>
            </div>
          </div>-->
          <!-- Slide Three - Set the background image for this slide in the line below -->
          <!--<div class="carousel-item" style="background-image: url('http://placehold.it/1900x1080')">
            <div class="carousel-caption d-none d-md-block">
              <h3>Third Slide</h3>
              <p>This is a description for the third slide.</p>
            </div>
          </div>
        </div>--><!--
        <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="sr-only">Next</span>
        </a>
      </div>-->
    </header>

    <!-- Page Content -->
    <section id="about" class="py-5"  style="background-color:pink">
      <div class="container">
        <h1>What is IRPi?</h1>
        <p>IRPi is a universal IoT IR remote based on Raspberry Pi. It allows you to control any IR-based device such as TVs, set-top boxes and air conditioners. IRPi controls mulitple devices from the cloud using a simple and intuitive interface.</p>
        <!--<p>The background images for the slider are set directly in the HTML using inline CSS. The rest of the styles for this template are contained within the
          <code>half-slider.css</code>file.</p>-->
      </div>
    </section>

    <section class="py-5" id="demo">
      <div class="container">
        <h1>Demo</h1>
        <p>Youtube Video</p>
      </div>
    </section>

    <section class="py-5" id="features" style="background-color:lightblue;">
      <div class="container">
        <h1>Features</h1>
        <ul>
          <li>Record and Transmit any IR signal</li>        
          <li>Control your device through a mobile-friendly website</li>       
          <li>Manage multiple Raspberry Pi's from the cloud</li>
          <li>Set timers for future remote commands</li>          
          <li>Access manually through easy HTTP Requests</li>
        </ul>
      </div>
    </section>

    <section class="py-5" id="ir" style="background-color:pink">
      <div class="container">
        <h2>Putting the IR in IRPi</h2>
        <p>IR (Infra red) is a light wave with a longer wavelength than red light - this makes it invisible to the human eye. Since many day-to-day objects naturally emmit IR signal, IR remotes/receivers don't simply emmit and record IR; they use a unique protocol. Only when the transmitter modulates IR at a 38Khz frequency, the receiver detects a 'low' signal. This can be explained simply by the following diagram.</p>

        <img src="photos/ir_signal.png" margin-bottom="20px">

        <p>In order to read and transmit IR codes, we used the GPIO library provided by microsoft. It allows a user to read and write to the GPIO pins on the RPi.<br>
		Since we worked with Windows 10, which is not a real time operating system, this part was quite challenging. As explained earlier, to recive and transmit IR codes there is a need to change from high to low voltage in a 38kHz frequency. Altough the RPi is fast enough, the operation system often stops the code in order to maintain itself. Therefore our naive attempts to obtain an accurate and reliable 38kHz rate failed and we had to find smarter solutions.<br>
        For reading signals, the IR reciver outputs 'high' or 'low' voltage based on the IR frequency as showen in the last diagram. We used the GPIOChangeReader class which places timestamps in kernal mode then later read from the device in user mode, this allows to record fast changes in the IR receiver signal.<br>
        Transmitting was a bigger challenge for us. For that purpuse we used a '555 timer' connected to the IR LED on our breadboard. The '555 timer' modulates a 38kHz frequency, and we use the GPIO to enable or disable the timer. The output of the timer is connected to the IR LED.</p>
      </div>
    </section>
	
    <section class="py-5" id="circuit">
      <div class="container">
        <h1>Building the IRPi</h1>
        <p>The universal remote is built from the following- a Raspberry Pi 3, an IR receiver and an IR transmitter (LED). The IR LED is connected to a 555 timer that modulates a 38kHz frequency. It also contains a green* LED for debugging and a pushbutton to accept input. The following diagram shows the wiring of the IRPi:</p>

        <img src="photos/breadboard_with_info.png" margin-bottom="20px" margin-top="20px" width="70%">
		<p>* Don't use a red LED for debugging! It might interfere with the IR receiver.</p>
      </div>
    </section>

    <section class="py-5" id="cloud">
      <div class="container">
        <h1>Communication with the cloud</h1>
        <p>Our project's communcation is done through several cloud services provideed by Microsoft Azure. The main parts are:</p>
        <ul>
          <li>Azure App Service - Web App</li>        
          <li>Cloud Storage - Azure Storage Table</li>
          <li>Azure Functions</li>       
          <li>IoT Hub</li>
        </ul>
        <p>The following diagram explains the interactions between these services:</p>

        <img src="photos/cloud_communication.png" margin-bottom="20px" width="100%">
      </div>

      <div class="container" >
        <h4>IoT Hub</h4>
        <p>IoT Hub is a service that was designed for IoT device connectivity, and this is the main reason for choosing this exact service. The IoT Hub provides per-device identity and revocable access control, which is crucial for IoT in general and particulary for IRPi - we have to ensure that the users are safe, or else a hacker can contol frequently used item in the victim's house or houses. IoT Hub is also optimized for scaling, can support millions of simultaneously connected devices. This is a big part of IRPi, the goal is to let everyone control every IR device from anywhere.</p>
        <h4>Web App</h4>
        <p>Azure suggests few options for hosting websites: App Service, Cloud Service, Virtual Machine, and Service Fabric. We chose to use App Service as it fits our goals best - it allows quick deployment and handles scaling. In the following paragraph we describe the main pros and cons for each option.</p>
        <p><b>App Service</b> - This service handles scaling and load balancing. It also allows quick deployment and is relatively easy to use. This service does not allow remote desktop access. If one wish to start using an App Service for an existing site, small changes might be needed.<br>
		<b>Cloud Service</b> - This is a legacy service and it's recommended not to use it in new projects.<br>
		<b>Virtual Machine</b> - The main advantage of a Virtual Machine is that you can take a local project and upload it 'as is'. But as this is a Infrastructure-as-a-Service (IaaS) and not a Platform-as-a-Service (Paas), maintenance is needed. Therfore for a new projects PaaS is preferred.<br>
		<b>Service Fabric</b> - This service is similar to App Service, it makes scaling and load balancing easy, and allows quick deployment. Service Fabric also allows more direct controll over the underlying infrastructure. This service is relatively new.<br>Service Fabric also offers the features we need, but we don't need the control over the underlying infrastructure and preferred to work with a service that exists for a longer time.</p>
		</p>
		<p>
		Deeper overview can be found <a href="https://docs.microsoft.com/en-us/azure/app-service-web/choose-web-site-cloud-service-vm#onprem">here</a>.
		</p>
		<h4>Azure Functions</h4>
        <p>Azure Functions are a strong tool given by Azure. They allow to run short pieces of code without building an application or infrastructure around them.<br>
		When using Azure Functions, there are 2 possible types of pricing plans:
		<ul>
          <li><b>Consumption plan</b> - pay for the time your code runs.</li>      
          <li><b>App Service plan</b> - run your Azure Functions on the infrastructure used for an existing App Service with no additional cost.</li>
        </ul>
		As we host our site using an App Service, we chose the App Service plan.</p>
		<p>
		We have coded 3 Azure Functions:<br>
		<b>Store recordings</b> - This function is triggered when a D2C (Device to Cloud) message arrives to the IoT Hub. The function parses the message and insert it to an Azure Storage Table named IRRecordingTable.<br>
		<b>Execute schedule tasks</b> - This function is triggered once a minute. For any message in the Azure Storage Table named IRScheduleTable, it checkes wheter it should be transmitted now, and if so the function invokes a corresponding direct method.<br>
		<b>Handle API calls</b> - This function is triggered when an HTTP Post request is sent to it's URI. It handles requests that contain the following parameters: DeviceID, ProductName and ActionName. For any such request it reads the wanted IR message from IRRecordingTable and invokes a direct method for the relevant device.<br>
		</p>
        <h4>Azure Storage Table</h4>
        <p>There are two main databases that Azure provides, these are Azure Storage Table and SQL Azure. SQL Azure is great for when you want to work with structured data using relations, indexes, constraints,  while Azure Table Storage is great for centralized structured data without relations. Each row in an Azure Storage Table is unikly defined by a PartitionKey and a RowKey, they're also used for physically partitioning the tables, which provides load balancing and scalability.<br>
		We chose to work with Azure Storage Table rather than SQL Azure because of the load balancing and scalability factor and also because it is much cheaper when you work with bulk storage.</p>
        <h2>Communication examples</h2>
   		<h4>Trasnmit</h4>
		<p>The following diagram explains what happens when a web user clicks on a transmit button:</p>
		<img src="photos/transmit_diagram.png" margin-bottom="20px" width="80%">
		<ol>
			<li>A GET request is sent to the Web app sufficient info to know which IR message the user clicked on.</li>
			<li>The Web app asks the Storage Table for the appropriate IR message in the IRRecordingTable with the information from the GET request.</li>
			<li>The Storage Table retrievs the IR message and sents is back to the Web app.</li>
			<li>The Web app invokes a direct method which tells the IoT Hub which device should transmit and what message.</li>
			<li>The IoT then communicates with the chosen device and forwards him the IR message to transmit.</li>
		</ol> 
		
        <h4>Record</h4>
        <p>The following diagram explains what happens when a web user wishes to record a new message:</p>
		<img src="photos/recording_diagram.png" margin-bottom="20px" width="80%">
		<ol>
			<li>The web user chooses a device, product name and action name and then clicks a button to start recording. After the click, a GET request is sent to the Web app with the device ID.</li>
			<li>The Web app then invokes a direct method which tells the IoT Hub which device should <b>start</b> recording.</li>
			<li>The IoT communicates with the chosen device and tell it to start recording.</li>
			<li>When the web user wishes to end the recording, he presses the appropriate button. This sends a GET request to the Web app with the device ID, product name and action name as parameters.</li>
			<li>The Web app then invokes a direct method which tells the IoT Hub which device should <b>stop</b> recording. It also forwards the product name and action name chosen by the web user.</li>
			<li>The IoT then communicates with the chosen device and tells him to end the recording and gives him the rest of the parameters.</li>
			<li>The chosen device sends a D2C message with the recording, product name and action name.</li>
			<li>An Azure Function listens to messages from endpoint devices. When a D2C message is sent from a device the Azure Function handles it.</li>
			<li>The Azure Function inserts a new item to IRRecordingTable with the given IR message, product name, action name and device ID. 
		</ol>
        <h4>Schedule</h4>
        <p>The following diagram explains the proccess of making a shedule and auto executing it:</p>
		<img src="photos/schedule_diagram.png" margin-bottom="20px" width="80%">
		<p>This is what happens when a web user wishes to schedule a new message:</p>
		<ol>
			<li>The web user chooses a message to schedule and then sets a trigger time for when it should be trasmited. After a click on the submit button a GET request is sent to the Web app with the appropriate parameters.</li>
			<li>The Web app adds a new row to the IRScheduleTable with the information from the GET request.</li>
		</ol>
		<p>The following proccess is automatic and runs as an Azure Function every minute:</p>
		<ol type="A">
			<li>The Azure Function asks for the information stored in IRScheduleTable.</li>
			<li>The Storage Table retrievs the desired table and sends it back to the Azure Function.</li>
			<li>For every message in the table that its schedule time arrived, the Azure Function ivokes a direct method to tell the IoT Hub which device should transmit and what message.</li>
			<li>The IoT then communcates with the chosen device and forwards him the IR message to transmit.</li>
		</ol> 

      </div>

    </section>
	
	<section class="py-5" id="api" style="background-color:lightblue">
      <div class="container">
        <h2>API</h2>
        <p>As time goes by, more and more devices contain computers. The vision behind IoT is to allow communication between all of our devices. It becomes more common for new devices to be controlled by comupters that are connected to the internet. Yet, some important daily devices are still being controlled by an IR remote.
		Using the API you can now controll those IR devices via simple HTTP requests.</p>

		
        <h4>How to use the API</h4>
		<p>In order to use the api, all you need is to send a POST request to the following URL:</p>
		<!-- HTML generated using hilite.me --><div style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">https:<span style="color: #666666">//</span>irpihandlemessages<span style="color: #666666">.</span>azurewebsites<span style="color: #666666">.</span>net<span style="color: #666666">/</span>api<span style="color: #666666">/</span>HttpGET<span style="color: #666666">-</span>HandleApiCalls
</pre></div>
		<p>The request should contain the following parameters: DeviceID, ProductName, ActionName. These can be found on the website.<br>
		For example, here is a short python code that samples the weather (from OWM, openweathermap.org) and turns on the air conditioner if the temperature is below 20°.</p>
		
<!-- HTML generated using hilite.me --><div style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">pyowm</span>
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">requests</span>
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">json</span>
<span style="color: #007020; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">time</span> <span style="color: #007020; font-weight: bold">import</span> gmtime, strftime, sleep

owm <span style="color: #666666">=</span> pyowm<span style="color: #666666">.</span>OWM(<span style="color: #4070a0">&#39;XXX&#39;</span>)  <span style="color: #60a0b0; font-style: italic"># Connecting to OWM, place a valid free key instead of XXX</span>

location <span style="color: #666666">=</span> <span style="color: #4070a0">&#39;Tel Aviv,isr&#39;</span>

url <span style="color: #666666">=</span> <span style="color: #4070a0">&#39;https://irpihandlemessages.azurewebsites.net/api/HttpGET-HandleApiCalls&#39;</span>  	<span style="color: #60a0b0; font-style: italic"># API&#39;s url</span>
turnOnData <span style="color: #666666">=</span> 								<span style="color: #60a0b0; font-style: italic"># Building the data of the post request</span>
	{<span style="color: #4070a0">&#39;DeviceID&#39;</span> : <span style="color: #4070a0">&#39;MainDevice&#39;</span>,
          <span style="color: #4070a0">&#39;ProductName&#39;</span> : <span style="color: #4070a0">&#39;aircon&#39;</span>,
          <span style="color: #4070a0">&#39;ActionName&#39;</span> : <span style="color: #4070a0">&#39;on&#39;</span> }
		  
<span style="color: #007020; font-weight: bold">while</span> <span style="color: #007020">True</span>:
	<span style="color: #007020; font-weight: bold">print</span>(<span style="color: #4070a0">&quot;Checking weather in &quot;</span> <span style="color: #666666">+</span> location <span style="color: #666666">+</span> <span style="color: #4070a0">&quot; &quot;</span> <span style="color: #666666">+</span> strftime(<span style="color: #4070a0">&quot;%Y-%m-</span><span style="color: #70a0d0; font-style: italic">%d</span><span style="color: #4070a0"> %H:%M:%S&quot;</span>, gmtime()))
	
	<span style="color: #60a0b0; font-style: italic"># Access the temperature using the pyowm lib</span>
	observation <span style="color: #666666">=</span> owm<span style="color: #666666">.</span>weather_at_place(location)
	w <span style="color: #666666">=</span> observation<span style="color: #666666">.</span>get_weather()
	temperature <span style="color: #666666">=</span> w<span style="color: #666666">.</span>get_temperature(<span style="color: #4070a0">&#39;celsius&#39;</span>)
	
	<span style="color: #007020; font-weight: bold">print</span> (temperature)
	
	<span style="color: #007020; font-weight: bold">if</span>(temperature[<span style="color: #4070a0">&#39;temp&#39;</span>] <span style="color: #666666">&lt;</span> <span style="color: #40a070">20</span>):
		r <span style="color: #666666">=</span> requests<span style="color: #666666">.</span>post(url, data <span style="color: #666666">=</span> json<span style="color: #666666">.</span>dumps(turnOnData))	<span style="color: #60a0b0; font-style: italic"># Send a post requset the turns on the air conditioner		</span>
		<span style="color: #007020; font-weight: bold">print</span>(r<span style="color: #666666">.</span>text)						<span style="color: #60a0b0; font-style: italic"># Print result</span>
	<span style="color: #007020; font-weight: bold">else</span>:
		<span style="color: #007020; font-weight: bold">print</span>(<span style="color: #4070a0">&quot;Don&#39;t turn on aircon&quot;</span>)
		
	sleep(<span style="color: #40a070">60</span>)
</pre></div>
<br>


    <h4>How the API works</h4>
	<p>
	We've written an Azure Function App that handles the API requests. When a request arrives, the function reads the IR message from the Azure Table and then invokes a direct method similarly to the example from the <a href="#cloud">Communication with the cloud</a> section.
	</p>
	
	</div>
    </section>


    <section id="code" class="py-5">
      <div class="container">
        <h1>Source & Documentation</h1>
		<h2>Link to GitHub</h2>
             
      </div>
    </section>


    <section class="py-5">
      <div class="container">
        <h1>Miscellaneous</h1>
		<h2>Security</h2>
		<p>
		The dream of IoT to become part of every device in our houses can become a nightmare if we won't take care of security. As this is a prototype project, we did not provide full security. On the other hand, we did note the steps that should be taken to add security and took them into account while working on other fronts.<br>
		We used Azure Authentication for App Services to create a friendly login (with google accounts) and made sure that inner pages can only be accessed by verified users. Furthermore, we turned on the data encryption in the Azure Storage Tables.<br>
		We believe that the next security concern that needs treatment is to change the way we identify devices. Instead of giving any device a name, we should have a long random key for each device, then we can ask for this key on requests to invoke a direct methods. We should also add timestamps for this requests to avoid replay attacks.
		</p>
		<h2>Scaling</h2>
		<p>
		The ability to scale is an important property that might be hidden when the project is in the 'Proof of Concept' stage. However, the entire structure of our project is built to allow scaling. Through the <a href='#cloud'>Communication with the cloud</a> section, the explenations behind our choices convince that we used the right tools to allow Azure take care of the scaling for us.
		</p>
		<h2>Timezones</h2>
		<p>Don't know if you noticed, but we went the extra mile and implemented the user timezone inside the scheduling proccess. The schedule table stores the trigger time in respect to GMT +00:00, this means that when we insert and retrieve items to and from the table we must do it with respect to the user's current timezone.<p>
	  </div>
    </section>


	<section id="us" class="wrapper style1 special">
	    <div class="inner">
	        <header>
	            <h2>IRPi</h2>
	            <p>The Universal IoT IR Remote</p>
	        </header>
	        <div class="flex flex-4">
	            <div class="box person">
	                <div class="image round">
	                    <img src="photos/Omer.jpg" alt="Omer Kafri" />
	                </div>
	                <h3>Omer Kafri</h3>
	            </div>
	            <div class="box person">
	                <div class="image round">
	                    <img src="photos/Amit.jpg" alt="Amit Atsmon" />
	                </div>
	                <h3>Amit Atsmon</h3>
	            </div>
	            <div class="box person">
	                <div class="image round">
	                    <a href="https://youtu.be/PWgvGjAhvIw?t=212"><img src="photos/Gal.jpg" alt="Gal Wiernik" /></a>
	                </div>
	                <h3>Gal Wiernik</h3>
	            </div>
	        </div>
	    </div>
	</section>



    <!-- Footer -->
    <footer class="py-5 bg-dark">
      <div class="container">
        <p class="m-0 text-center text-white">Copyright &copy; IRPi 2017</p>
      </div>
      <!-- /.container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/popper/popper.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>

  </body>

</html>
